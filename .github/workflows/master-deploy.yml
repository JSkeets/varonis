name: Master Deploy Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
    - name: Trigger Infrastructure Bootstrap
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'infrastructure-bootstrap.yml',
            ref: 'main',
            inputs: {
              environment: '${{ github.event.inputs.environment }}'
            }
          })

    - name: Wait for Infrastructure Bootstrap
      uses: actions/github-script@v6
      with:
        script: |
          let completed = false;
          while (!completed) {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'infrastructure-bootstrap.yml',
              branch: 'main',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length) {
              const run = runs.data.workflow_runs[0];
              const status = run.status;  // 'queued', 'in_progress', or 'completed'
              const conclusion = run.conclusion;  // null, 'success', 'failure', etc.
              
              console.log(`Infrastructure Bootstrap - Status: ${status}, Conclusion: ${conclusion}`);
              
              if (status !== 'completed') {
                console.log('Workflow still running...');
              } else if (conclusion === 'success') {
                completed = true;
              } else {
                core.setFailed(`Infrastructure Bootstrap failed with conclusion: ${conclusion}`);
                return;
              }
            } else {
              console.log('No workflow runs found yet, waiting...');
            }
            
            if (!completed) {
              console.log('Waiting for Infrastructure Bootstrap to complete...');
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
          }

  build:
    needs: bootstrap
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
    - name: Trigger Build and Push
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'build-and-push.yml',
            ref: 'main',
            inputs: {
              environment: '${{ github.event.inputs.environment }}'
            }
          })

    - name: Wait for Build and Push
      uses: actions/github-script@v6
      with:
        script: |
          let completed = false;
          while (!completed) {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-and-push.yml',
              branch: 'main',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length) {
              const run = runs.data.workflow_runs[0];
              const status = run.status;
              const conclusion = run.conclusion;
              
              console.log(`Build and Push - Status: ${status}, Conclusion: ${conclusion}`);
              
              if (status !== 'completed') {
                console.log('Workflow still running...');
              } else if (conclusion === 'success') {
                completed = true;
              } else {
                core.setFailed(`Build and Push failed with conclusion: ${conclusion}`);
                return;
              }
            } else {
              console.log('No workflow runs found yet, waiting...');
            }
            
            if (!completed) {
              console.log('Waiting for Build and Push to complete...');
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
          }

  terraform:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
    - name: Trigger Terraform Apply
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'terraform-apply.yml',
            ref: 'main',
            inputs: {
              environment: '${{ github.event.inputs.environment }}'
            }
          })

    - name: Wait for Terraform Apply
      uses: actions/github-script@v6
      with:
        script: |
          let completed = false;
          while (!completed) {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-apply.yml',
              branch: 'main',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length) {
              const run = runs.data.workflow_runs[0];
              const status = run.status;
              const conclusion = run.conclusion;
              
              console.log(`Terraform Apply - Status: ${status}, Conclusion: ${conclusion}`);
              
              if (status !== 'completed') {
                console.log('Workflow still running...');
              } else if (conclusion === 'success') {
                completed = true;
              } else {
                core.setFailed(`Terraform Apply failed with conclusion: ${conclusion}`);
                return;
              }
            } else {
              console.log('No workflow runs found yet, waiting...');
            }
            
            if (!completed) {
              console.log('Waiting for Terraform Apply to complete...');
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
          }

  seed:
    needs: terraform
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
    - name: Trigger DynamoDB Seed
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'seed-dynamodb.yml',
            ref: 'main',
            inputs: {
              environment: '${{ github.event.inputs.environment }}'
            }
          })

    - name: Wait for DynamoDB Seed
      uses: actions/github-script@v6
      with:
        script: |
          let completed = false;
          while (!completed) {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'seed-dynamodb.yml',
              branch: 'main',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length) {
              const run = runs.data.workflow_runs[0];
              const status = run.status;
              const conclusion = run.conclusion;
              
              console.log(`DynamoDB Seed - Status: ${status}, Conclusion: ${conclusion}`);
              
              if (status !== 'completed') {
                console.log('Workflow still running...');
              } else if (conclusion === 'success') {
                completed = true;
              } else {
                core.setFailed(`DynamoDB Seed failed with conclusion: ${conclusion}`);
                return;
              }
            } else {
              console.log('No workflow runs found yet, waiting...');
            }
            
            if (!completed) {
              console.log('Waiting for DynamoDB Seed to complete...');
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
          }

  deploy-api:
    needs: seed
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Deploy API
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy-api.yml',
            ref: 'main',
            inputs: {
              environment: '${{ github.event.inputs.environment }}',
              image_tag: '${{ github.sha }}'
            }
          })

    - name: Get API Gateway URL
      run: |
        cd terraform/environments/us-east-1/${{ github.event.inputs.environment }}
        API_URL=$(terraform output -raw api_gateway_url)
        echo "API_URL=$API_URL" >> $GITHUB_ENV

    - name: Notify Success
      if: success()
      run: |
        echo "✅ Master deployment to ${{ github.event.inputs.environment }} completed successfully!"
        echo "API Gateway URL: ${{ env.API_URL }}"
        echo "Example curl command:"
        echo "curl -X POST ${{ env.API_URL }}/restaurant/query -H 'Content-Type: application/json' -d '{\"query\": \"test query\"}'"

    - name: Notify Failure
      if: failure()
      run: |
        echo "❌ Master deployment to ${{ github.event.inputs.environment }} failed!"

    - name: Wait for API Deploy
      uses: actions/github-script@v6
      with:
        script: |
          let completed = false;
          while (!completed) {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-api.yml',
              branch: 'main',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length) {
              const run = runs.data.workflow_runs[0];
              const status = run.status;
              const conclusion = run.conclusion;
              
              console.log(`API Deploy - Status: ${status}, Conclusion: ${conclusion}`);
              
              if (status !== 'completed') {
                console.log('Workflow still running...');
              } else if (conclusion === 'success') {
                completed = true;
              } else {
                core.setFailed(`API Deploy failed with conclusion: ${conclusion}`);
                return;
              }
            } else {
              console.log('No workflow runs found yet, waiting...');
            }
            
            if (!completed) {
              console.log('Waiting for API Deploy to complete...');
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
          }

  check-status:
    needs: [bootstrap, build, terraform, seed, deploy-api]
    runs-on: ubuntu-latest
    steps:
    - name: Wait for workflows to complete
      run: sleep 30

    - name: Check Workflow Status
      uses: actions/github-script@v6
      with:
        script: |
          const workflows = [
            'infrastructure-bootstrap.yml',
            'build-and-push.yml',
            'terraform-apply.yml',
            'seed-dynamodb.yml',
            'deploy-api.yml'
          ];
          
          for (const workflow of workflows) {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              branch: 'main',
              per_page: 1
            });
            
            if (!runs.data.workflow_runs.length) {
              core.setFailed(`No runs found for ${workflow}`);
              return;
            }
            
            const status = runs.data.workflow_runs[0].conclusion;
            console.log(`${workflow} status: ${status}`);
            
            if (status !== 'success') {
              core.setFailed(`Workflow ${workflow} failed with status: ${status}`);
              return;
            }
          }
          
          console.log('All workflows completed successfully!');

    - name: Notify Success
      if: success()
      run: |
        echo "✅ All deployments completed successfully!"

    - name: Notify Failure
      if: failure()
      run: |
        echo "❌ One or more deployments failed. Check the workflow logs for details." 